---
title: "03f0modify"
output: html_document
date: "2023-05-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## check for two things: missing f0, or jump f0

1. We first want to give a report about the f0 errors by file, combinig the missing and the jumping
2. For each file, we save the visualisation of these files.
3. Then in python, we run a script to extract these files into a seperate folder. We also have a query system, to show the visualisation figure of a file
4. Use praat to open thse files and modifiy the boundary. It is likely that we will need to generate 
```{r}
library(readr)
library(dplyr)
library(ggplot2)
#Show Chinese characters
library(showtext)
showtext_auto()
```

```{r}
cantonese.missing <- read_csv("./datafiles/Cantonese_missingf0_check.csv", col_names = TRUE,show_col_types = FALSE)
cantonese.jumping <- read_csv("02output_files/data_summary_by_ID_errors_only.csv", col_names = TRUE,show_col_types = FALSE)
cantonese.target <- read_csv("./datafiles/Cantonese_forf0check.csv", col_names = TRUE,show_col_types = FALSE)

data <- cantonese.target
missing <- cantonese.missing
# When it gets to be really small dataset, the variable types can be wrong. Therefore it's better to have all steps in one file.
# missing$tone <- as.character(missing$tone)
# missing$enum <- as.numeric(missing$enum)
# missing$defaultf0floor <- as.numeric(missing$defaultf0floor)
# missing$defaultf0ceiling <- as.numeric(missing$defaultf0ceiling)
# missing$idx <- as.numeric(missing$idx)
# missing$minTime <- as.numeric(missing$minTime)
# missing$maxTime <- as.numeric(missing$maxTime)
# missing$rhyme_duration <- as.numeric(missing$rhyme_duration)
# missing$f0min <- as.numeric(missing$f0min)
# missing$f0min_time <- as.numeric(missing$f0min_time)
# missing$f0max <- as.numeric(missing$f0max)
# missing$f0max_time <- as.numeric(missing$f0max_time)
jumping <- cantonese.jumping
```
```{r}
missing$missing <- 1
error_data <- data %>% 
  inner_join(jumping,by= "uniqueID") %>%
  full_join(missing) %>%
  relocate(uniqueID, .before = 1) %>%
  select(-minTime, -maxTime, -f0min_time, -f0max_time)
# Replace NA with zero
# error_data$missing <- replace(error_data$missing, is.na(error_data$missing),0)
error_data$err_count_by_ID <- replace(error_data$error_data$err_count_by_ID, is.na(error_data$err_count_by_ID),0)
```
# Plot
## prepare the data to long format
```{r}
error_data.long <- error_data %>%
  pivot_longer(cols = matches('t[0-9]+', ignore.case = FALSE), names_to = "Time",names_prefix = "t", values_to = "f0") %>% # Convert to the standard long format
  group_by(participant) %>%
  mutate(
    f0ref = mean(f0, na.rm = T),
    f0_semi = 12*log(f0/f0ref,2)
  ) %>%
  ungroup()
```

Save file information for python to open them
```{r}
flagfiles <- error_data %>%
  group_by(filename) %>%
  summarise(chars = paste(character, collapse = ", "), defaultf0floor = mean(defaultf0floor),defaultf0ceiling = mean(defaultf0ceiling))
write.csv(flagfiles, "Can_flagfiles.csv", row.names = FALSE)
```

Plot and save individual files
```{r}
# target <- "S5dia1nI1_2"
for (target in unique(error_data.long$uniqueID)){
  plotdata <- subset(error_data.long, uniqueID == target)
  plot.title <- paste0(unique(plotdata$character), "jump:",unique(plotdata$err_prop_by_ID), " missing:", unique(plotdata$missing))
  plotdata %>%
  mutate(
    Time = as.numeric(Time)
  ) %>%
  ggplot(aes(x = Time, y = f0_semi)) + 
  geom_line() + 
  geom_point() +
  ggtitle(plot.title) + 
  theme(plot.title = element_text(size = 30))
ggsave(filename = paste0("03figures/",target,".png"),width = 7, height = 5)
}

```



